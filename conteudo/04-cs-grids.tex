\chapter{Cubed-sphere grids}
\label{chp-cs-grids}

The cubed-sphere grid was originally proposed by \citet{sadourny:1972} and was 
reinvestigated by \citet{ronchi:1996} and \citet{rancic:1996}. 
As is usual for Planotic grids, we start with a Platonic solid, in this case, a cube, 
which is circumscribed in a sphere. We then project its faces onto the sphere.
The original cubed-sphere, called the equidistant cubed-sphere, was proposed by 
\citet{sadourny:1972} but resulted in a non-uniform grid. 
To address this issue, a solution was proposed by introducing angular coordinates, 
leading to a quasi-uniform grid known as the equiangular cubed-sphere.
The cubed sphere consists of six panels, each one having a local Cartesian coordinate 
system. 
This makes it easier to extend methods from the plane to the sphere. 
In fact, \citet{putman:2007} extends the dimension splitting technique from 
\citet{lin:1996}, as presented in Chapter \ref{chp-2d-fv}, to the cubed-sphere.

There are essentially two major challenges when working with the cubed-sphere grid:
\begin{enumerate}
\item
The non-orthogonal grid system: This challenge is primarily related to the appearance of
metric terms in the equations. It adds computational cost and often requires conversions
between contravariant and covariant components of a velocity field.
\item
The discontinuity of the coordinate system at the cube edges: This is perhaps the most 
problematic challenge. Computing stencils along the cube edges becomes challenging due to 
the discontinuous nature of the coordinate system.
\end{enumerate}
One possible approach to compute stencils at the edges is to extend the local coordinate 
of each panel to its neighboring panels, adding ghost cells in the halo region. In the 
case of the equiangular cubed-sphere, ghost cell values lie on the same geodesics 
containing the data from the neighboring panels. This allows for the use of one-dimensional
high-order Lagrange interpolation to compute the stencils at the edges. 
This approach has been extensively used in the literature \citep{croisille:2013, 
katta:2015, katta:2015b, chen:2021} and was initially introduced by \citet{ronchi:1996}.
Alternatively, \citet{putman:2007} uses extrapolation for grid values near the cube edges.
Another approach that avoids the need for interpolation or extrapolation near the edges is 
the conformal cubed-sphere developed by \citet{rancic:1996}. While this grid leads to an 
orthogonal and continuous coordinate system near the edges, it generates grid singularities
near the cube corners, similar to the pole problem. 
An improved and more uniform conformal grid, called the Uniform Jacobian cubed sphere, was 
later proposed by \citet{rancic:2017}.
Each approach is likely to generate grid imprinting, and one of the goals of this work is 
to investigate the amount of grid imprinting produced by each method.

This chapter aims to review and investigated the geometrical properties
of the cubed-sphere. Besides that, we also aim to investigate the process
of interpolating/extrapolating near the cube edges.
We start with a basic review of the cubed-sphere mappings in Section \ref{cs-mappings},
while Section \ref{cs-halodata} investigates the interpolation/extrapolation near the cube
edges with some numerical experiments.

\section{Cubed-sphere mappings}
\label{cs-mappings}
\subsection{Equidistant cubed-sphere}
\label{equidistant-cs}
We start this chapter by introducing the equidistant cubed-sphere proposed by 
\citet{sadourny:1972}. Given $R>0$, we denote the sphere of radius $R$ 
centered at the origin of  $\mathbb{R}^3$ as:
\begin{equation*}
	\mathbb{S}^2_R = \{ P = (X,Y,Z) \in \mathbb{R}^3: X^2 + Y^2 + Z^2 = R^2\}.
\end{equation*}
We consider a parameter $a = \frac{R}{\sqrt{3}}$ representing the half-length of 
the cube, and the family of maps
$\Psi_{p}: [-a,a] \times [-a,a] \to \mathbb{S}^2_R$, $p=1, \ldots, 6$,
where:
\begin{equation*}
	\Psi_{1}(x,y) = \frac{R}{\sqrt{a^2 + x^2 + y^2}}(a, x, y), 
\end{equation*}
\begin{equation*}
	\Psi_{2}(x,y) = \frac{R}{\sqrt{a^2 + x^2 + y^2}}(-x, a, y), 
\end{equation*}
\begin{equation*}
	\Psi_{3}(x,y) = \frac{R}{\sqrt{a^2 + x^2 + y^2}}(-a, -x, y), 
\end{equation*}
\begin{equation*}
	\Psi_{4}(x,y) = \frac{R}{\sqrt{a^2 + x^2 + y^2}}(x, -a, y), 
\end{equation*}
\begin{equation*}
	\Psi_{5}(x,y) = \frac{R}{\sqrt{a^2 + x^2 + y^2}}(-y, x, a), 
\end{equation*}
\begin{equation*}
	\Psi_{6}(x,y) = \frac{R}{\sqrt{a^2 + x^2 + y^2}}(y, x, -a).
\end{equation*}
The set of 6 maps $\{\Psi_{p}, p = 1, \ldots, 6\}$ allow us to cover the sphere.
Here $p$ denotes a panel, and they are defined and orientated as Figure \ref{chp4-panels}
shows. Then, we can represent a point on the sphere using the cubed-sphere coordinates
$(x,y,p)$.

The derivative of the maps $\Psi_p$ are given by:
\begin{equation*}
	D\Psi_{1}(x,y) = \frac{R}{{(a^2 + x^2 + y^2)}^{3/2}}
	\begin{bmatrix}
		-ax & -ay \\
	 	 a^2+y^2  & -xy \\
		 -xy  & a^2+x^2
	\end{bmatrix},
\end{equation*}
\begin{equation*}
	D\Psi_{2}(x,y) = \frac{R}{{(a^2 + x^2 + y^2)}^{3/2}}
	\begin{bmatrix}
		-(a^2+y^2) & xy \\
		 -ax &  -ay \\
		 -xy &  a^2+x^2
	\end{bmatrix},
\end{equation*}
\begin{equation*}
	D\Psi_{3}(x,y) = \frac{R}{{(a^2 + x^2 + y^2)}^{3/2}}
	\begin{bmatrix}
		 ax &  ay \\
		-(a^2+y^2) & xy \\
		 -xy &  a^2+x^2
	\end{bmatrix},
\end{equation*}
\begin{equation*}
	D\Psi_{4}(x,y) = \frac{R}{{(a^2 + x^2 + y^2)}^{3/2}}	
	\begin{bmatrix}
		 a^2+y^2 &  -xy \\
		 ax & ay \\
		 -xy &  a^2+x^2
	\end{bmatrix},
\end{equation*}
\begin{equation*}
	D\Psi_{5}(x,y) = \frac{R}{{(a^2 + x^2 + y^2)}^{3/2}}	
	\begin{bmatrix}
		 xy  & -(a^2+x^2) \\
	 	 a^2+y^2  &  -xy \\
		-ax & -ay
	\end{bmatrix},
\end{equation*}
\begin{equation*}
	D\Psi_{6}(x,y) = \frac{R}{{(a^2 + x^2 + y^2)}^{3/2}}
	\begin{bmatrix}
		 -xy  &  a^2+x^2 \\
		 a^2+y^2  &  -xy \\
		 ax &  ay
	\end{bmatrix}.
\end{equation*}
With the aid of the derivative, we may define a basis of tangent vectors 
$\{ \boldsymbol{g}_{x}, \boldsymbol{g}_{y} \}$ on each point on the sphere by:
\begin{equation*}
	\boldsymbol{g}_{x}(x,y,p) = D\Psi_{p}(x,y)
	\begin{bmatrix}
		 1 \\
		 0
	\end{bmatrix},
	\boldsymbol{g}_{y}(x,y,p) = D\Psi_{p}(x,y)
	\begin{bmatrix}
		 0 \\
		 1
	\end{bmatrix}.
\end{equation*}
Notice that
\begin{equation*}
	\label{chp3-eqdistant-psitensor}
	[D\Psi_{p}(x,y)]^TD\Psi_{p}(x,y)
	= \frac{R^2}{(a^2 + x^2 + y^2)^2}
	\begin{bmatrix}
		 a^2 + x^2 &  -xy \\
		 -xy & a^2 + y^2
	\end{bmatrix},
\end{equation*}
does not depend on $p$.
Hence, it makes sense to define the matrix 
$G_{\Psi}(x,y) = [D\Psi_{p}(x,y)]^TD\Psi_{p}(x,y)$ 
which is known as metric tensor.
It is easy to see that:
\begin{equation*}
	\label{chp3-eqdistant-psi-metric-tensor}
	G_{\Psi}(x,y) = 
	\begin{bmatrix}
		\langle \boldsymbol{g}_{x}(x,y,p), \boldsymbol{g}_{x}(x,y,p) \rangle & 
		\langle \boldsymbol{g}_{x}(x,y,p), \boldsymbol{g}_{y}(x,y,p) \rangle \\
		\langle \boldsymbol{g}_{x}(x,y,p), \boldsymbol{g}_{y}(x,y,p) \rangle  &
		\langle \boldsymbol{g}_{y}(x,y,p), \boldsymbol{g}_{y}(x,y,p) \rangle 
	\end{bmatrix},
\end{equation*}
where $\langle \cdot, \cdot \rangle$ denotes 
the standard inner product of $\mathbb{R}^3$,
and that $G_{\Psi}(x,y)$ is positive-definite, 
$\forall (x,y) \in [-a,a]\times[-a,a]$.
The Jacobian of the metric tensor $G_{\Psi}(x,y)$ is then given by:
\begin{equation*}
	\sqrt{|\det{G_{\Psi}(x,y)}|} = \frac{R^2}{(a^2+x^2+y^2)^{3/2}}a.
\end{equation*}
\begin{figure}[!htb]
	\centering
		\includegraphics[width=0.8\linewidth]{chp4_panels}
	\caption{Cubed-sphere panels definition and orientation.
    Figure taken from \citet{jung:2019}.\label{chp4-panels}}
\end{figure}

\subsection{Equiangular cubed-sphere}
\label{equiangular-cs}
Another cubed-sphere mapping is the equiangular mapping \citep{ronchi:1996},
which leads to a more uniform grid.
This mapping is a composition of equidistant mapping with angular coordinates.
We consider again $a=\frac{R}{\sqrt{3}}$ and we define the family of maps
$\Phi_{p}: [-\frac{\pi}{4},\frac{\pi}{4}]  \times [-\frac{\pi}{4},\frac{\pi}{4}] 
\to \mathbb{S}^2_R$, $p=1, \ldots, 6$, given by $\Phi_{p}(x,y) = \Psi_{p}(a\tan{x},
a\tan{y})$.
The coordinates $(a\tan{x}, a\tan{y})$ are called angular coordinates.
By the chain rule:
\begin{equation*}
	D\Phi_{p}(x,y) = a
	D\Psi_{p}(a\tan{x}, a\tan{y})
	\begin{bmatrix}
		\frac{1}{\cos^2 x} & 0 \\ 
		0 & \frac{1}{\cos^2 y} 
	\end{bmatrix},
\end{equation*}
and therefore we can define the following tangent vectors
\begin{align}
    \label{chp4-tgvectors}
	\boldsymbol{r}_{x}(x,y,p) = D\Phi_{p}(x,y)
	\begin{bmatrix}
		 1 \\
		 0
	\end{bmatrix}
	= \frac{a}{\cos^2 x}
	\boldsymbol{g}_{x}(\tan{x}, \tan{y}, p)
	,\\
	\boldsymbol{r}_{y}(x, y ,p) = D\Phi_{p}(x,y)
	\begin{bmatrix}
		 0 \\
		 1
	\end{bmatrix}
	= \frac{a}{\cos^2 y}
	\boldsymbol{g}_{y}(\tan{x}, \tan{y}, p),
\end{align}
Again, it makes sense to define the matrix 
\begin{align*}
	G_{\Phi}(x,y) &= [D\Phi_{p}(x,y)]^TD\Phi_{p}(x,y) \\
	&= a^2
	[D\Psi_{p}(a\tan{x},a\tan{y})]^T
	\begin{bmatrix}
		\frac{1}{\cos^4 x} & 0 \\ 
		0 & \frac{1}{\cos^4 y} 
	\end{bmatrix}
	D\Psi_{p}(a\tan{x}, a\tan{y}),
\end{align*}
that does not depend on $p$ and is the  metric tensor.
It is easy to see that:
\begin{equation}
	\label{chp3-eqangle-phi-metric-tensor}
	G_{\Phi}(x,y) = 
	\begin{bmatrix}
		\langle \boldsymbol{r}_{x}(x,y,p), \boldsymbol{r}_{x}(x,y,p) \rangle & 
		\langle \boldsymbol{r}_{x}(x,y,p), \boldsymbol{r}_{y}(x,y,p) \rangle \\
		\langle \boldsymbol{r}_{x}(x,y,p), \boldsymbol{r}_{y}(x,y,p) \rangle  &
		\langle \boldsymbol{r}_{y}(x,y,p), \boldsymbol{r}_{y}(x,y,p) \rangle 
	\end{bmatrix},
\end{equation}
and that $G_{\Phi}(x,y)$ is positive-definite, 
$\forall (x,y) \in [-\frac{\pi}{4},\frac{\pi}{4}] 
\times [-\frac{\pi}{4},\frac{\pi}{4}]$.
The Jacobian of the metric tensor $G_{\Phi}(x,y)$ is then given by:
\begin{align}
	\label{metrictensor-cs-equiangular}
	\begin{split}
		\sqrt{|\det{G_{\Phi}(x,y)}|} &= \frac{a}{\cos^2 x \cos^2 y}
		\frac{R^2}{(a^2 + a^2\tan^2x + a^2\tan^2y)^{3/2}}a\\
		&= \frac{R^2}{\cos^2 x \cos^2 y}
		\frac{1}{(1 + \tan^2x + \tan^2y)^{3/2}}.
	\end{split}
\end{align}

\section{Tangent vectors on the sphere}
\label{cs-tgvectors}
The tangent space at $P \in \mathbb{S}^2_R$ by $T_P \mathbb{S}^2$.
It is easy to see that:
\begin{equation*}
	T_P\mathbb{S}^2_R = \{P_0 \in \mathbb{R}^3: \langle P,P_0\rangle = 0\}.
\end{equation*}
We are going to consider three ways to represent an element of $\mathbb{S}_R^2$:
using $(X,Y,Z)$ coordinates, or using $(\lambda, \phi)$
latitude-longitude coordinates, or, at last, using the cubed-sphere
coordinates $(x,y,p)$, where $(x,y)$ are the cube face coordinates and 
$p \in \{1,2,\cdots, 6\}$ stands for a cube panel.

We say that a vector field $\boldsymbol{u}: \mathbb{S}^2_R \to 
\mathbb{R}^3$ is tangent on  the sphere if
$\boldsymbol{u}(P) \in T_P\mathbb{S}^2_R$, $\forall P \in \mathbb{S}^2_R$.

\subsection{Conversions between latitude-longitude and contravariant coordinates}
\label{anexo-sph-ll}
We consider the latitude-longitude mapping 
$\Psi_{ll}: [0,2\pi] \times [-\frac{\pi}{2},\frac{\pi}{2}] \to \mathbb{S}^2_R$, given by:
\begin{align}
	\label{ll2sph}
	X(\lambda,\phi) &= R\cos \phi \cos \lambda,\\
	Y(\lambda,\phi) &= R\cos \phi \sin \lambda,\\
	Z(\lambda,\phi) &= R\sin \phi.
\end{align}
The derivative or Jacobian matrix of the mapping $\Psi_{ll}$ is given by:
\begin{equation}
	\label{dpsi}
	D\Psi_{ll} (\lambda,\phi) = 
	R \begin{bmatrix}
		  -\cos \phi \sin \lambda &  -\sin \phi \cos \lambda \\
		   \cos \phi \cos \lambda & \sin \phi \sin \lambda \\
		  0  &  \cos \phi
	\end{bmatrix}.
\end{equation}
Using this matrix columns, we can define the tangent vectors:
\begin{equation}
	\boldsymbol{r}_{\lambda}(\lambda,\phi) = D\Psi_{ll}(\lambda,\phi)
	\begin{bmatrix}
		 1 \\
		 0
	\end{bmatrix}, \quad
	\boldsymbol{r}_{\phi}(\lambda,\phi) = D\Psi_{ll}(\lambda,\phi)
	\begin{bmatrix}
		 0 \\
		 1
	\end{bmatrix}.
\end{equation}
We normalize the vectors $\boldsymbol{r}_\lambda$ and $\boldsymbol{r}_\phi$
and we obtain unit tangent vectors on the sphere at $\Phi_{ll}(\lambda, \phi)$:
\begin{equation}
	\label{latlon_tg_vectors}
	\boldsymbol{e}_{\lambda}(\lambda,\phi) = 
	\begin{bmatrix}
		 -\sin \lambda \\
		  \cos \lambda \\
		  0
	\end{bmatrix}, \quad
	\boldsymbol{e}_{\phi}(\lambda,\phi) =
	\begin{bmatrix}
		 -\sin \phi \cos \lambda \\
		 -\sin \phi \sin \lambda \\
			  \cos \phi
	\end{bmatrix}.
\end{equation}
Let us consider a tangent vector field $\boldsymbol{u}: \mathbb{S}^2_R \to 
\mathbb{R}^3$ on the sphere, represented as
\begin{equation}
	\label{latlon-wind}
	\boldsymbol{u}(\lambda, \phi) = 
    u_{\lambda} (\lambda, \phi) \boldsymbol{e}_{\lambda} (\lambda, \phi) + 
	v_{\phi} (\lambda, \phi) \boldsymbol{e}_{\phi} (\lambda, \phi). 
\end{equation}
Or, we may also represent this vector field using the basis 
obtained by cubed-sphere coordinates:
\begin{equation}
	\label{contravariant-wind}
	\boldsymbol{u}(x, y, p) = 
	{u}(x, y, p) \boldsymbol{r}_{x}(x, y, p) + 
	{v}(x, y, p) \boldsymbol{r}_{y}(x, y, p).
\end{equation}
This representation is known as contravariant representation.
In order to relate the latitude-longitude representation
with the contravariant representation, we notice that:
\begin{align}
	\label{basis-convertion1}
	\boldsymbol{r}_x(x, y, p) &= 
	\langle \boldsymbol{r}_{x} , \boldsymbol{e}_{\lambda}\rangle
	\boldsymbol{e}_{\lambda} (\lambda, \phi)  
	+ \langle \boldsymbol{r}_{x} , \boldsymbol{e}_{\phi}\rangle
	\boldsymbol{e}_{\phi} (\lambda, \phi), \\
	\label{basis-convertion2}
	\boldsymbol{r}_y(x, y, p) &=  
	\langle \boldsymbol{r}_{y} , \boldsymbol{e}_{\lambda}\rangle
	  \boldsymbol{e}_{\lambda} (\lambda, \phi) 
	+ \langle \boldsymbol{r}_{y} , \boldsymbol{e}_{\phi}\rangle
	\boldsymbol{e}_{\phi} (\lambda, \phi), 
\end{align}
which holds since the vectors $\boldsymbol{e}_{\lambda}(\lambda, \phi)$ and
$\boldsymbol{e}_{\phi}(\lambda, \phi)$ are orthogonal.
Replacing Equations \eqref{basis-convertion1} and \eqref{basis-convertion2}
in Equation \eqref{contravariant-wind}, we obtain the values $(u_\lambda, v_\phi)$
in terms of the contravariant components $({u},{v})$ 
as the following matrix equation:
\begin{equation}
	\label{ll-to-contravariant}
	\begin{bmatrix}
		 u_\lambda (\lambda, \phi) \\
		 v_\phi (\lambda, \phi) 
	\end{bmatrix}
	=
	\begin{bmatrix}
		\langle \boldsymbol{r}_x, \boldsymbol{e}_\lambda \rangle 
		& \langle \boldsymbol{r}_y, \boldsymbol{e}_\lambda \rangle \\
		\langle \boldsymbol{r}_x, \boldsymbol{e}_\phi \rangle 
		& \langle \boldsymbol{r}_y, \boldsymbol{e}_\phi \rangle \\
	\end{bmatrix}
	\begin{bmatrix}
		{u}(x,y,p) \\
		{v}(x,y,p)
	\end{bmatrix}.
\end{equation}
Conversely, we may express the contravariant components in terms of
latitude-longitude components by inverting Equation \eqref{ll-to-contravariant}:
\begin{equation}
	\label{contravariant-to-ll}
	\begin{bmatrix}
		{u}(x,y,p) \\
		{v}(x,y,p)
	\end{bmatrix}
	=
	\frac{1}{\langle \boldsymbol{r}_x, \boldsymbol{e}_\lambda\rangle
	\langle \boldsymbol{r}_y, \boldsymbol{e}_\phi \rangle
	-\langle \boldsymbol{r}_y, \boldsymbol{e}_\lambda \rangle
	\langle \boldsymbol{r}_x, \boldsymbol{e}_\phi \rangle}
	\begin{bmatrix}
		  \langle \boldsymbol{r}_y, \boldsymbol{e}_\phi \rangle 
		&-\langle \boldsymbol{r}_y, \boldsymbol{e}_\lambda \rangle \\
		 -\langle \boldsymbol{r}_x, \boldsymbol{e}_\phi \rangle 
		& \langle \boldsymbol{r}_x, \boldsymbol{e}_\lambda \rangle \\
	\end{bmatrix}
	\begin{bmatrix}
		 u_\lambda (\lambda, \phi) \\
		 v_\phi (\lambda, \phi) 
	\end{bmatrix}.
\end{equation}

\subsection{Covariant/contravariant conversion}
\label{anexo-cov-con}
Let us consider again a tangent vector field $\boldsymbol{u}: \mathbb{S}^2_R \to 
\mathbb{R}^3$ on the sphere, the contravariant representation of 
$\boldsymbol{u}$ is given by Equation \eqref{contravariant-wind}.
The covariant components $(U,V)$ are given by:
\begin{align}
	\label{covariant-u}
	U(x,y,p) = \langle \boldsymbol{u}(x,y,p) , \boldsymbol{r}_x(x,y,p)  \rangle, \\
	\label{covariant-v}
	V(x,y,p) = \langle \boldsymbol{u}(x,y,p) , \boldsymbol{r}_y(x,y,p)  \rangle.
\end{align}
Replacing Equation \eqref{contravariant-wind} in 
Equations \eqref{covariant-u} and \eqref{covariant-v} we obtain
the relation covariant components in terms of the
contravariant terms:
\begin{equation}
	\label{contravariant-to-covariant}
	\begin{bmatrix}
		{U}(x,y,p) \\
		{V}(x,y,p)
	\end{bmatrix}
	=
	\begin{bmatrix}
		  \langle \boldsymbol{r}_x, \boldsymbol{r}_x \rangle
		& \langle \boldsymbol{r}_x, \boldsymbol{r}_y \rangle \\
		  \langle \boldsymbol{r}_x, \boldsymbol{r}_y \rangle 
		& \langle \boldsymbol{r}_y, \boldsymbol{r}_y \rangle \\
	\end{bmatrix}
	\begin{bmatrix}
		{u} (x,y,p) \\
		{v} (x,y,p) 
	\end{bmatrix}.
\end{equation}
We may express the contravariant components in terms of 
the covariant terms inverting Equation \eqref{contravariant-to-covariant}:
\begin{equation}
	\label{convariant-to-contravariant}
	\begin{bmatrix}
		{u}(x,y,p) \\
		{v}(x,y,p)
	\end{bmatrix}
	= \frac{1}{\langle \boldsymbol{r}_x, \boldsymbol{r}_x \rangle
               \langle \boldsymbol{r}_y, \boldsymbol{r}_y \rangle
             - \langle \boldsymbol{r}_x, \boldsymbol{r}_y \rangle^2}
	\begin{bmatrix}
		  \langle \boldsymbol{r}_y, \boldsymbol{r}_y \rangle
		& -\langle \boldsymbol{r}_x, \boldsymbol{r}_y \rangle \\
		  -\langle \boldsymbol{r}_x, \boldsymbol{r}_y \rangle 
		& \langle \boldsymbol{r}_x, \boldsymbol{r}_x \rangle \\
	\end{bmatrix}
	\begin{bmatrix}
		{U} (x,y,p) \\
		{V} (x,y,p) 
	\end{bmatrix}.
\end{equation}
Notice that combining Equations \eqref{contravariant-to-covariant}
and \eqref{convariant-to-contravariant} with Equations 
\eqref{ll-to-contravariant} and \eqref{contravariant-to-ll}
one may get relations between the latitude-longitude 
components and the covariant components.

\section{Notation}
\label{cs-notation}
Hereafter, we shall denote $g(x,y) = |\det{G_{\Phi}(x,y)}|$.

To represent the cubed-sphere grid, we consider the notation of Section \ref{sec:fv-2d}.
We shall assume that we have a $(\Delta x, \Delta y)-$grid of $[-a,a]^2$, with $\Delta x= \Delta y$, $N=M$,
where $a$ depends on the mapping considered.
Similarly to Chapter \ref{chp-2d-fv}, we may extend the grid to ghost cells.
Hence, for each $p=1, \ldots, 6$, we apply the mapping $\Psi_p$ or $\Phi_p$ on
each local coordinate system grid to generate the cubed-sphere with $6N^2$ cells.
In Figure \ref{chp4-cs-grid}, we depict an example of the grids generated using 
the equidistant and equiangular mappings for $N=20$.
\begin{figure}[!htb]
	\centering
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[width=1\linewidth]{gnomonic_equidistant_20_sphere}
		\caption{Equidistant}
	\end{subfigure}
	\begin{subfigure}{0.48\textwidth}
		\centering
		\includegraphics[width=1\linewidth]{gnomonic_equiangular_20_sphere}
		\caption{Equiangular}
	\end{subfigure}
	\caption{Equidistant (a) and equiangular (b) cubed-spheres generated with $N=20$.
		\label{chp4-cs-grid}}
\end{figure}

From Figure \ref{chp4-cs-grid}, we notice that the equiangular cubed-sphere is much more uniform
than the equidistant cubed-sphere. As pointed out by \citet{rancic:1996}, the ratio
between the maximum and minimum cell area on the equiangular cubed-sphere is approximately 1.3,
while the same ratio is approximately 5.2 on the equidistant cubed-sphere. 


\section{Edges treatment}
\label{cs-halodata}
\subsection{Ghost cells interpolation}
\label{cs-interp}
Hereafter, we are going to use the notation $(x,y;p)$ for $p=1,\ldots, 6$, to represent a point on the sphere obtained through the equiangular cubed-sphere mapping.
Let us assume that we have a function $q: \mathbb{S}^2_R \to \mathbb{R}$
given at the cell centroids and let us denote these values by $q_{ijp} = q(x_i,y_j;p)$,
for $i, j=1\ldots, N$, $p=1,\ldots, 6$. We wish to estimate these values outside of the range $1, \ldots, N$, that is, we wish to estimate them at ghost cell positions.

As we pointed out before, this can be done by noticing that the ghost cells on the local
Cartesian systems are mapped onto the geodesic of a adjacent panel, which allows us to use Lagrange interpolation to obtain the ghost cell values.
To illustrate this process in Panel 1, in Figure \ref{chp4-cs-halodata} we depict the values of $q_{ijp}$ using green circles for Panel 1 and black circles for the other panels, for $N=8$. Assuming a halo size equal to 3, we also show the target value at ghost cell positions using yellow and magenta circles. Observe that the dashed yellow lines in Figure \ref{chp4-cs-halodata} illustrate
how the ghost cell points lye in geodesics containing grid position from adjacent panels. Except for the magenta circles,
all the ghost cell values may be obtained using 1D Lagrange interpolation using the surrounding black circles on the geodesic.
This can be performed for all panels. After that, the magenta circles may be interpolated using also the values obtained in the first step of interpolation
(see cyan circles in Figure \ref{chp4-cs-halodata}), preserving the order of accuracy of the interpolation, supposing this one is fixed. 
\begin{figure}[!htb]
	\centering
	\includegraphics[width=1.0\linewidth]{gnomonic_equiangular_8_mercator}
	\caption{Equiangular cubed-sphere panel 1 with $N=8$: 
	centroid at panel 1 (green circles) and others panel centroids (black circles), 
	ghost cell points at panel 1 (yellow and magenta circles) and others panels (cyan circles).}
	\label{chp4-cs-halodata}
\end{figure}

We are going to show a numerical example of this interpolation process using a halo region of size 4 and 
assuming the radius of the sphere is equal to one.
We shall consider the following trigonometric function, which is the divergence of a velocity field,
as in \citet{peixoto:13} in our tests:
\begin{align}
	\label{chp4-ic2}
	\begin{split}
	q(\lambda, \phi) = \frac{1}{\cos(\phi)}\bigg(-2\cos^3(\phi) \sin(\lambda) \cos(\lambda)
	+16\sin^2(\lambda)\cos(\lambda)\cos^3(\phi)\sin(\phi)\bigg),
	\end{split}
\end{align}
whose graph is depicted in Figure \ref{chp4-cs-ic2}. We are going to consider the relative error in the maximum norm and the convergence rate 
at the ghost cell positions defined analogously as in Section \ref{sec-ds-exp}. 
We also consider values os $N$ given by $2^k$, for $k=4, \ldots, 10$, in order to compute the error and convergence rate.
In Figures \ref{chp4-exp2} we show the error and convergence rate for the trigonometric function (Equation \eqref{chp4-ic2}),
respectively, considering polynomials of degrees from 0 up to 4. As both graphs show, we were able to achieve the expected order of convergence.
Next, we shall use the ghost cell interpolation when computing the stencils from PPM edge reconstructions presented in Chapter \ref{chp-1d-fv}
in each direction of a panel and also compare the results obtained with extrapolation.

\begin{figure}[!htb]
	\centering
	\includegraphics[width=1\linewidth]{gnomonic_equidistant_1024_interp_q_ic_2_mercator}
	\caption{Trigonometric function defined by Equation \eqref{chp4-ic2}.}
	\label{chp4-cs-ic2}
\end{figure}

\begin{figure}[!htb]
	\centering
	\begin{subfigure}{0.45\textwidth}
		\centering
		\includegraphics[width=1\linewidth]{cs_interp_ic2_normlinf_errors}
		\caption{Error.\label{chp4-exp2-error}}
	\end{subfigure}
	\begin{subfigure}{0.45\textwidth}
		\centering
		\includegraphics[width=1\linewidth]{cs_interp_ic2_normlinf_convergence_rate}
		\caption{Convergence rate.\label{chp4-exp2-CR}}
	\end{subfigure}
	\caption{Relative error convergence (a) and convergence rate (b) for the ghost cell interpolation process for different
		polynomial degrees, using the trigonometric function given by Equation \eqref{chp4-ic2}.\label{chp4-exp2}}
\end{figure}

\subsection{Edges reconstruction}
\label{cs-recon}
Let denote a control volume of the cubed-sphere by $\Omega_{ijp}$, that is:
\begin{equation*}
	\Omega_{ijp} = \Phi_p([x_{i-\frac{1}{2}}, x_{i+\frac{1}{2}}] \times [y_{j-\frac{1}{2}}, y_{j+\frac{1}{2}}]),
	\quad 1 \leq i, j \leq N, \quad 1 \leq p \leq 6.
\end{equation*}
We define the average values of a function $q$ with the aid of the metric tensor $g(x,y)$ (Equation \ref{metrictensor-cs-equiangular}):
\begin{equation*}
	Q_{ijp} = \frac{1}{|\Omega_{ijp}|}\int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}}
	\int_{y_{j-\frac{1}{2}}}^{y_{j+\frac{1}{2}}}  q(x,y;p) \sqrt{g(x,y)}\,dx \,dy,
\end{equation*}
where $|\Omega_{ijp}|$ is the control volume area given by:
\begin{equation*}
	|\Omega_{ijp}| = \int_{x_{i-\frac{1}{2}}}^{x_{i+\frac{1}{2}}} \int_{y_{j-\frac{1}{2}}}^{y_{j+\frac{1}{2}}}\sqrt{g(x,y)} \,dx \,dy.
\end{equation*}
Similar to Proposition \ref{prop-bound-centroid-2d}, we may approximate the average value using the centroid value, that is
\begin{equation*}
	Q_{ijp} - q_{ijp} = O(\Delta x ^2), 
\end{equation*}
where $q_{ijp} = q(x_i,y_j; p)$, recalling that on the cubed-sphere we always assume $\Delta x = \Delta y$.
In this work, we shall always approximate the average values since our schemes are expected to be at most second-order,
this approximation does not deteriorate the convergence order.

Let us consider the following problem: given the values $q_{ijp}$ we wish to find approximations of 
the function $q$ at the control volume edge midpoints denoted by
$q^{L,x}_{ijp}  \approx q_{{i-\frac{1}{2}},j,p}$,
$q^{R,x}_{ijp}  \approx q_{{i+\frac{1}{2}},j,p}$,
$q^{L,y}_{ijp}  \approx q_{i,{j-\frac{1}{2}},p}$,
$q^{R,y}_{ijp}  \approx q_{i,{j+\frac{1}{2}},p}$, where we also using the notations
$q_{{i+\frac{1}{2}},j,p}  \approx q(x_{i+\frac{1}{2}},y_j; p)$,
$q_{i,{j+\frac{1}{2}},p}  \approx q(x_i,y_{j+\frac{1}{2}}; p)$.
These points are illustrated in Figure \ref{csgrid-rpoints} for panel 1.
\begin{figure}[!htb]
	\centering
	\includegraphics[width=1\linewidth]{gnomonic_equiangular_8_mercator_2}
	\caption{The reconstruction problem on the cubed-sphere panel 1: we are given the centroid values of a function (black circles)
		and we wish to estimate these values at the edges midpoints in the $x$ direction (blue circles) and $y$ direction (red circles).
		This figure uses an equiangular cubed-sphere with $N=8$.} \label{csgrid-rpoints}
\end{figure}

We can estimate the desired values using the one-dimensional reconstruction schemes from Sections \ref{chp2-sec-recon} and \ref{chp2-sec-mono}
by performing the PPM reconstruction in the $x$ and $y$ directions independently.
Notice that all the schemes from Sections \ref{chp2-sec-recon} and \ref{chp2-sec-mono} are expected to be second-order accurate due to centroid point approximation.
The major difference here is when we compute the stencil near the cube edges. 
Unlikely the previous chapters where we assumed periodic boundary conditions, the boundary conditions are related to the adjacent panels.
One way to overcome this problem is just to add ghost cell layers and use the process described in Section \ref{cs-interp}, hence
all the stencils may be computed. 
This approach shall be referred to as \textbf{ET-R96} (ET stands for edge treatment) since this approach of extending the grid lines and using Lagrange interpolation was originally proposed in \citet{ronchi:1996}.

Another way to fill the ghost cell values used for instance in \citet{sadourny:1972}, is just to ignore the discontinuity of the coordinate 
system and use the values of the cells in the adjacent panels as the ghost cell values. This scheme is labeled  \textbf{ET-S72}.
An approach that avoids the use of ghost cells has been developed by \citet{putman:2007} using 
extrapolation at the cells surrounding to the cube edge.
We are going to describe this scheme that we shall name \textbf{ET-PL07}. This scheme uses the following extrapolations:
\begin{align*}
	q^{L,x}_{1,j,p} &= \frac{1}{2}\bigg(3Q_{1,j,p} - Q_{2,j,p}\bigg),\\
	q^{R,x}_{N,j,p} &= \frac{1}{2}\bigg(3Q_{N,j,p} - Q_{N-1,j,p}\bigg),\\
	q^{L,y}_{i,1,p} &= \frac{1}{2}\bigg(3Q_{i,1,p} - Q_{i,2,p}\bigg),\\
	q^{R,y}_{i,N,p} &= \frac{1}{2}\bigg(3Q_{i,N,p} - Q_{i,N-1,p}\bigg),\\
\end{align*}
at the points that are located on the cube edges. The other edge values are estimated as:
\begin{align*}
	q^{R,x}_{1,j,p} &= \frac{1}{14}\bigg(3Q_{1,j,p} + 11Q_{2,j,p} - 2(Q_{3,j,p} - Q_{1,j,p})\bigg),\\
	q^{L,x}_{2,j,p} &= q^{R,x}_{1,j,p},\\
	q^{L,x}_{N,j,p} &= \frac{1}{14}\bigg(3Q_{N,j,p} + 11Q_{N-1,j,p} - 2(Q_{N-2,j,p} - Q_{N,j,p})\bigg),\\
	q^{R,x}_{N-1,j,p} &= q^{L,x}_{N,j,p},\\
\end{align*}
in the $x$ direction and in the $y$ direction we use the formulas
\begin{align*}
	q^{R,y}_{i,1,p} &= \frac{1}{14}\bigg(3Q_{i,1,p} + 11Q_{i,2,p} - 2(Q_{i,3,p} - Q_{i,1,p})\bigg),\\
	q^{L,y}_{i,2,p} &= q^{R,x}_{i,1,p},\\
	q^{L,y}_{i,N,p} &= \frac{1}{14}\bigg(3Q_{i,N,p} + 11Q_{i,N-1,p} - 2(Q_{i,N-2,p} - Q_{i,N,p})\bigg),\\
	q^{R,y}_{i,N-1,p} &= q^{L,y}_{i,N,p}.\\
\end{align*}
We are going to use the trigonometric function (Equation \eqref{chp4-ic2})
as before on the unit sphere to compare the schemes ET-R96, ET-S72 and ET-PL07. The scheme ET-R96 uses cubic polynomials.
We introduce the relative errors:
\begin{align*}
	e_{{i-\frac{1}{2}},j,p} &= (|q_{{i-\frac{1}{2}},j,p} - q^{L,x}_{ijp}|)/|q_{{i-\frac{1}{2}},j,p}|,\\
	e_{{i+\frac{1}{2}},j,p} &= (|q_{{i+\frac{1}{2}},j,p} - q^{R,x}_{ijp}|)/|q_{{i+\frac{1}{2}},j,p}|,\\
	e_{i,{j-\frac{1}{2}},p} &= (|q_{i,{j-\frac{1}{2}},p} - q^{L,y}_{ijp}|)/|q_{i,{j-\frac{1}{2}},p}|,\\
	e_{i,{j+\frac{1}{2}},p} &= (|q_{i,{j+\frac{1}{2}},p} - q^{R,y}_{ijp}|)/|q_{i,{j+\frac{1}{2}},p}|,\\
	e_{ijp} &= \max\{e_{{i-\frac{1}{2}},j,p}, e_{{i+\frac{1}{2}},j,p} , e_{i,{j-\frac{1}{2}},p}, e_{i,{j+\frac{1}{2}},p} \},\\
	E &= \max \{e_{ijp}\}.
\end{align*}
We are going to compute $E$ for different values of $N$ as in the numerical experiments of Section \ref{cs-interp}.
\begin{figure}[!htb]
	\centering
	\begin{subfigure}{0.45\textwidth}
		\centering
		\includegraphics[width=1\linewidth]{cs_recon_ic2_normlinf_parabola_errors}
		\caption{Error.\label{chp4-exp3-error}}
	\end{subfigure}
	\begin{subfigure}{0.45\textwidth}
		\centering
		\includegraphics[width=1\linewidth]{cs_recon_ic2_normlinf_convergence_rate}
		\caption{Convergence rate.\label{chp4-exp3-CR}}
	\end{subfigure}
	\caption{Relative error convergence (a) and convergence rate (b) for the reconstruction problem for different
	edge treatments (ET), using the trigonometric function given by Equation \eqref{chp4-ic2}.\label{chp4-exp3}}
\end{figure}

In Figure \ref{chp4-exp3} we show the errors and the convergence rate using the PPM-PL07 and PPM-L04 reconstruction schemes.
We can observe that all the schemes converge to zero with second-order.
The difference between the edge treatments ET-S72, ET-PL07 and ET-R96 schemes
may be observed in Figure \ref{chp4-exp4} and Figure \ref{chp4-exp5}, for the  PPM-PL07 and PPM-L04 reconstruction schemes, respectively.
We notice that the cube edges appear on the error graph when we use the ET-S72 and ET-PL07 schemes. This is an example of grid imprinting.
Although all schemes are second-order, the scheme ET-R96 do not seem to produce grid imprinting in the reconstruction problem.

\begin{figure}[!htb]
	\centering
	\begin{subfigure}{0.49\textwidth}
		\centering
		\includegraphics[width=1\linewidth]{gnomonic_equiangular_1024_recon_q_ic_2_reconPPM-PL07_etET-S72_sphere}
		\caption{ET-S72.\label{chp4-exp4-a}}
	\end{subfigure}
	\begin{subfigure}{0.49\textwidth}
		\centering
		\includegraphics[width=1\linewidth]{gnomonic_equiangular_1024_recon_q_ic_2_reconPPM-PL07_etET-PL07_sphere}
		\caption{ET-PL07.\label{chp4-exp4-b}}
	\end{subfigure}
	\begin{subfigure}{0.49\textwidth}
	\centering
	\includegraphics[width=1\linewidth]{gnomonic_equiangular_1024_recon_q_ic_2_reconPPM-PL07_etET-R96_sphere}
	\caption{ET-R96.\label{chp4-exp4-c}}
\end{subfigure}
	\caption{Error for the edge midpoint values considering the trigonometric function (Equation \eqref{chp4-ic2})
	with edges treatment schemes ET-S72 (a), ET-PL07 (b) and ET-R96 for the cubed-sphere with $N=1024$ using the reconstruction PPM-PL07.\label{chp4-exp4}}
\end{figure}

\begin{figure}[!htb]
	\centering
	\begin{subfigure}{0.49\textwidth}
		\centering
		\includegraphics[width=1\linewidth]{gnomonic_equiangular_1024_recon_q_ic_2_reconPPM-L04_etET-S72_sphere}
		\caption{ET-S72.\label{chp4-exp5-a}}
	\end{subfigure}
	\begin{subfigure}{0.49\textwidth}
		\centering
		\includegraphics[width=1\linewidth]{gnomonic_equiangular_1024_recon_q_ic_2_reconPPM-L04_etET-PL07_sphere}
		\caption{ET-PL07.\label{chp4-exp5-b}}
	\end{subfigure}
	\begin{subfigure}{0.49\textwidth}
		\centering
		\includegraphics[width=1\linewidth]{gnomonic_equiangular_1024_recon_q_ic_2_reconPPM-L04_etET-R96_sphere}
		\caption{ET-R96.\label{chp4-exp5-c}}
	\end{subfigure}
	\caption{As Figure in \ref{chp4-exp4} but using the PPM-L04 scheme.\label{chp4-exp5}}
\end{figure}


